name: Build & Publish php with nodejs multi-arch images to GHCR

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-7-1-7-2:
    name: Build PHP 7.1,7.2 images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php:      ["7.1","7.2"]
        node:     ["12","14"]
        composer: ["1"]
        variant:  ["alpine"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build & Push PHP ${{ matrix.php }}-node${{ matrix.node }}-composer${{ matrix.composer }}-${{ matrix.variant }}
        uses: docker/build-push-action@v4
        with:
          context: src
          file: src/Dockerfile.${{ matrix.php }}.${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/docker-php-node:${{ matrix.php }}-${{ matrix.node }}-${{ matrix.composer }}-${{ matrix.variant }}
          build-args: |
            PHP_VERSION=${{ matrix.php }}
            NODE_VERSION=${{ matrix.node }}
            COMPOSER_VERSION=${{ matrix.composer }}
  build-7-3-8-0:
    name: Build PHP 7.3,7.4,8.0 images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php:      ["7.3", "7.4", "8.0"]
        node:     ["16","18"]
        composer: ["1","2"]
        variant:  ["alpine"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build & Push PHP ${{ matrix.php }}-node${{ matrix.node }}-composer${{ matrix.composer }}-${{ matrix.variant }}
        uses: docker/build-push-action@v4
        with:
          context: src
          file: src/Dockerfile.${{ matrix.php }}.${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/docker-php-node:${{ matrix.php }}-${{ matrix.node }}-${{ matrix.composer }}-${{ matrix.variant }}
          build-args: |
            PHP_VERSION=${{ matrix.php }}
            NODE_VERSION=${{ matrix.node }}
            COMPOSER_VERSION=${{ matrix.composer }}

  build-8-1-8-4:
    name: Build PHP 8.1-8.4 images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php:      ["8.1","8.2","8.3","8.4"]
        node:     ["18","20","22"]
        composer: ["2"]
        variant:  ["alpine"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build & Push PHP ${{ matrix.php }}-node${{ matrix.node }}-composer${{ matrix.composer }}-${{ matrix.variant }}
        uses: docker/build-push-action@v4
        with:
          context: src
          file: src/Dockerfile.${{ matrix.php }}.${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/docker-php-node:${{ matrix.php }}-${{ matrix.node }}-${{ matrix.composer }}-${{ matrix.variant }}
          build-args: |
            PHP_VERSION=${{ matrix.php }}
            NODE_VERSION=${{ matrix.node }}
            COMPOSER_VERSION=${{ matrix.composer }}

  # build-8-5:
  #   name: Build PHP 8.5 images
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       php:      ["8.5"]
  #       node:     ["20", "22", "24"]
  #       composer: ["2"]
  #       variant:  ["alpine"]
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #     - name: Log in to GHCR
  #       uses: docker/login-action@v2
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #     - name: Set up Buildx
  #       uses: docker/setup-buildx-action@v2
  #     - name: Build & Push PHP ${{ matrix.php }}-node${{ matrix.node }}-composer${{ matrix.composer }}-${{ matrix.variant }}
  #       uses: docker/build-push-action@v4
  #       with:
  #         context: src
  #         file: src/Dockerfile.${{ matrix.php }}.${{ matrix.variant }}
  #         platforms: linux/amd64,linux/arm64
  #         push: true
  #         tags: ghcr.io/${{ github.repository_owner }}/docker-php-node:${{ matrix.php }}-${{ matrix.node }}-${{ matrix.composer }}-${{ matrix.variant }}
  #         build-args: |
  #           PHP_VERSION=${{ matrix.php }}
  #           NODE_VERSION=${{ matrix.node }}
  #           COMPOSER_VERSION=${{ matrix.composer }}